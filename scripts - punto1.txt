1. Instalación de dependencias

sudo apt update
sudo apt install libapache2-mod-authnz-external pwauth


libapache2-mod-authnz-external: permite que Apache use autenticadores externos.

pwauth: programa que conecta Apache con PAM para validar usuarios.

2. Configuración de PAM para pwauth

archivo /etc/pam.d/pwauth para definir cómo se hará la autenticación:

# Autenticación contra cuentas del sistema (shadow)
auth    required   pam_unix.so

# Niega acceso si el usuario está en /etc/security/denegados
account required   pam_listfile.so onerr=fail item=user sense=deny file=/etc/security/denegados

# Verificaciones normales de cuenta (expiración, bloqueo, etc.)
account required   pam_unix.so


3. Configuración de Apache (000-default.conf)

/etc/apache2/sites-available/000-default.conf para proteger el directorio /archivos_privados:

<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    ServerName 192.168.50.3
    DocumentRoot /var/www/html

    # --- Declaración del autenticador externo pwauth ---
    AddExternalAuth pwauth /usr/sbin/pwauth
    SetExternalAuthMethod pwauth pipe
    # ---------------------------------------------------

    <Directory "/var/www/html">
        Options FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    <Directory "/var/www/html/archivos_privados">
        Options -Indexes
        AllowOverride None

        AuthType Basic
        AuthName "Directorio Privado (PAM)"
        AuthBasicProvider external
        AuthExternal pwauth
        Require valid-user
        ErrorDocument 401 /error_401.html
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>



4. Lista de usuarios bloqueados

Archivo /etc/security/denegados ahí se añaden los usuarios a los que se les debe denegar acceso:

sudo vim /etc/security/denegados

juan
maria



5. Página de error personalizada que se mostrará si el usuario cancela el login o es rechazado:

sudo tee /var/www/html/error_401.html >/dev/null <<'HTML'
<!doctype html>
<meta charset="utf-8">
<h1>Acceso cancelado</h1>
<p>Debes iniciar sesión.</p>
HTML
